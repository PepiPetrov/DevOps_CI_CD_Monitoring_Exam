#!/bin/bash

# Import the Elastic Stack GPG key
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -

# Add the Elastic Stack APT repository to the sources list
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | tee /etc/apt/sources.list.d/elastic-8.x.list

# Update the package list again to include the Elastic Stack repository
apt-get update

# Install Elasticsearch
apt-get install -y elasticsearch

# Install Logstash
apt-get install -y logstash

# Configure Logstash to start automatically on boot and start it

# Install Kibana
apt-get install -y kibana

# Copy files
cp /vagrant/monitoring/jvm.options /etc/elasticsearch/jvm.options.d/jvm.options
cp /vagrant/monitoring/jvm.options.logstash /etc/logstash/jvm.options
cp /vagrant/monitoring/elasticsearch.yml /etc/elasticsearch/elasticsearch.yml
cp /vagrant/monitoring/kibana.yml /etc/kibana/kibana.yml
cp /vagrant/monitoring/beats.conf /etc/logstash/conf.d/beats.conf

# Configure stack to autorun on boot
systemctl daemon-reload
systemctl enable elasticsearch
systemctl start elasticsearch

systemctl daemon-reload
systemctl enable logstash
systemctl start logstash

systemctl daemon-reload
systemctl enable kibana
systemctl start kibana

sudo find / -name "*.deb" -type f -delete

while true; do 
  echo 'Trying to connect to http://192.168.99.100:5601 ...'; 
  if [ $(curl -s -o /dev/null -w "%{http_code}" http://192.168.99.100:5601) == "200" ]; then 
    echo '... connected.'; 
    break; 
  else 
    echo '... no success. Sleep for 5s and retry.'; 
    sleep 5; 
  fi 
done

# Import dashboard
cd /vagrant/monitoring
sleep 5
curl -X POST "http://192.168.99.100:5601/api/saved_objects/_import?overwrite=true" \
     -H "kbn-xsrf: true" \
     -H "Content-Type: application/json"
     -d "{"attributes":{"fieldAttrs":"{}","fieldFormatMap":"{}","fields":"[]","name":"Metricbeat","runtimeFieldMap":"{}","sourceFilters":"[]","title":"metricbeat-*","typeMeta":"{}"},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T08:22:56.467Z","id":"26c84e53-5e3d-4f41-aace-4e4edbfcbcce","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"sort":[1679818976467,74],"type":"index-pattern","updated_at":"2023-03-26T08:22:56.467Z","version":"Wzg1LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"title":"RAM Usage","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"RAM Usage\",\"type\":\"line\",\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"avg\",\"params\":{\"field\":\"system.memory.actual.used.bytes\",\"customLabel\":\"RAM % Used\"},\"schema\":\"metric\"},{\"id\":\"2\",\"enabled\":true,\"type\":\"date_histogram\",\"params\":{\"field\":\"@timestamp\",\"timeRange\":{\"from\":\"now-15m\",\"to\":\"now\"},\"useNormalizedEsInterval\":true,\"extendToTimeRange\":false,\"scaleMetricValues\":false,\"interval\":\"m\",\"used_interval\":\"1m\",\"drop_partials\":false,\"min_doc_count\":1,\"extended_bounds\":{}},\"schema\":\"segment\"},{\"id\":\"3\",\"enabled\":true,\"type\":\"terms\",\"params\":{\"field\":\"agent.name.keyword\",\"orderBy\":\"1\",\"order\":\"desc\",\"size\":5,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\",\"includeIsRegex\":true,\"excludeIsRegex\":true},\"schema\":\"group\"}],\"params\":{\"type\":\"line\",\"grid\":{\"categoryLines\":false},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true,\"scale\":{\"type\":\"linear\"},\"labels\":{\"show\":true,\"filter\":true,\"truncate\":100},\"title\":{},\"style\":{}}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true,\"scale\":{\"type\":\"linear\",\"mode\":\"normal\"},\"labels\":{\"show\":true,\"rotate\":0,\"filter\":true,\"truncate\":100},\"title\":{\"text\":\"RAM % Used\"},\"style\":{}}],\"seriesParams\":[{\"show\":true,\"type\":\"line\",\"mode\":\"normal\",\"data\":{\"label\":\"RAM % Used\",\"id\":\"1\"},\"valueAxis\":\"ValueAxis-1\",\"drawLinesBetweenPoints\":true,\"lineWidth\":2,\"interpolate\":\"linear\",\"showCircles\":true,\"circlesRadius\":1}],\"addTooltip\":true,\"detailedTooltip\":true,\"palette\":{\"type\":\"palette\",\"name\":\"default\"},\"addLegend\":true,\"legendPosition\":\"right\",\"fittingFunction\":\"linear\",\"times\":[],\"addTimeMarker\":false,\"truncateLegend\":true,\"maxLegendLines\":1,\"labels\":{},\"radiusRatio\":9,\"thresholdLine\":{\"show\":false,\"value\":10,\"width\":1,\"style\":\"full\",\"color\":\"#E7664C\"}}}"},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T08:22:56.467Z","id":"22fc9c10-c34a-11ed-85ef-bb8e0aa6c335","migrationVersion":{"visualization":"8.5.0"},"references":[{"id":"26c84e53-5e3d-4f41-aace-4e4edbfcbcce","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1679818976467,78],"type":"visualization","updated_at":"2023-03-26T08:22:56.467Z","version":"Wzg3LDFd"}
{"attributes":{"buildNum":59020,"defaultIndex":"26c84e53-5e3d-4f41-aace-4e4edbfcbcce","isDefaultIndexMigrated":true},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T08:21:01.763Z","id":"8.6.2","migrationVersion":{"config":"8.5.0"},"references":[],"sort":[1679820699031,116],"type":"config","updated_at":"2023-03-26T08:51:39.031Z","version":"WzEyMCwxXQ=="}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"title":"CPU Usage","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"CPU Usage\",\"type\":\"area\",\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"avg\",\"params\":{\"field\":\"system.cpu.system.pct\",\"customLabel\":\"CPU: System\"},\"schema\":\"metric\"},{\"id\":\"2\",\"enabled\":true,\"type\":\"avg\",\"params\":{\"field\":\"system.cpu.user.pct\",\"customLabel\":\"CPU: User\"},\"schema\":\"metric\"},{\"id\":\"3\",\"enabled\":true,\"type\":\"date_histogram\",\"params\":{\"field\":\"@timestamp\",\"timeRange\":{\"from\":\"now-15m\",\"to\":\"now\"},\"useNormalizedEsInterval\":true,\"extendToTimeRange\":false,\"scaleMetricValues\":false,\"interval\":\"m\",\"used_interval\":\"1m\",\"drop_partials\":false,\"min_doc_count\":1,\"extended_bounds\":{}},\"schema\":\"segment\"},{\"id\":\"4\",\"enabled\":true,\"type\":\"terms\",\"params\":{\"field\":\"agent.name.keyword\",\"orderBy\":\"1\",\"order\":\"desc\",\"size\":5,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\",\"includeIsRegex\":true,\"excludeIsRegex\":true},\"schema\":\"split\"}],\"params\":{\"type\":\"area\",\"grid\":{\"categoryLines\":false},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true,\"scale\":{\"type\":\"linear\"},\"labels\":{\"show\":true,\"filter\":true,\"truncate\":100},\"title\":{},\"style\":{}}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true,\"scale\":{\"type\":\"linear\",\"mode\":\"normal\"},\"labels\":{\"show\":true,\"rotate\":0,\"filter\":true,\"truncate\":100},\"title\":{\"text\":\"CPU: System\"},\"style\":{}}],\"seriesParams\":[{\"show\":true,\"type\":\"area\",\"mode\":\"stacked\",\"data\":{\"label\":\"CPU: System\",\"id\":\"1\"},\"drawLinesBetweenPoints\":true,\"lineWidth\":2,\"showCircles\":true,\"circlesRadius\":1,\"interpolate\":\"linear\",\"valueAxis\":\"ValueAxis-1\"},{\"show\":true,\"mode\":\"stacked\",\"type\":\"area\",\"drawLinesBetweenPoints\":true,\"showCircles\":true,\"circlesRadius\":1,\"interpolate\":\"linear\",\"lineWidth\":2,\"valueAxis\":\"ValueAxis-1\",\"data\":{\"id\":\"2\",\"label\":\"CPU: User\"}}],\"addTooltip\":true,\"detailedTooltip\":true,\"palette\":{\"type\":\"palette\",\"name\":\"default\"},\"addLegend\":true,\"legendPosition\":\"right\",\"fittingFunction\":\"linear\",\"times\":[],\"addTimeMarker\":false,\"truncateLegend\":true,\"maxLegendLines\":1,\"radiusRatio\":9,\"thresholdLine\":{\"show\":false,\"value\":10,\"width\":1,\"style\":\"full\",\"color\":\"#E7664C\"},\"labels\":{},\"row\":true}}"},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T08:22:56.467Z","id":"9182d460-c34a-11ed-85ef-bb8e0aa6c335","migrationVersion":{"visualization":"8.5.0"},"references":[{"id":"26c84e53-5e3d-4f41-aace-4e4edbfcbcce","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1679818976467,76],"type":"visualization","updated_at":"2023-03-26T08:22:56.467Z","version":"Wzg2LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"title":"Disk Free","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Disk Free\",\"type\":\"histogram\",\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"avg\",\"params\":{\"field\":\"system.fsstat.total_size.free\",\"customLabel\":\"Disk free\"},\"schema\":\"metric\"},{\"id\":\"2\",\"enabled\":true,\"type\":\"terms\",\"params\":{\"field\":\"agent.name.keyword\",\"orderBy\":\"1\",\"order\":\"desc\",\"size\":5,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\",\"includeIsRegex\":true,\"excludeIsRegex\":true},\"schema\":\"split\"}],\"params\":{\"type\":\"histogram\",\"grid\":{\"categoryLines\":false},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true,\"scale\":{\"type\":\"linear\"},\"labels\":{\"show\":true,\"filter\":true,\"truncate\":100},\"title\":{},\"style\":{}}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true,\"scale\":{\"type\":\"linear\",\"mode\":\"normal\"},\"labels\":{\"show\":true,\"rotate\":0,\"filter\":true,\"truncate\":100},\"title\":{\"text\":\"Disk free\"},\"style\":{}}],\"seriesParams\":[{\"show\":true,\"type\":\"histogram\",\"mode\":\"stacked\",\"data\":{\"label\":\"Disk free\",\"id\":\"1\"},\"interpolate\":\"linear\",\"valueAxis\":\"ValueAxis-1\",\"drawLinesBetweenPoints\":true,\"lineWidth\":2,\"showCircles\":true,\"circlesRadius\":1}],\"radiusRatio\":0,\"addTooltip\":true,\"detailedTooltip\":true,\"palette\":{\"type\":\"palette\",\"name\":\"default\"},\"addLegend\":true,\"legendPosition\":\"right\",\"times\":[],\"addTimeMarker\":false,\"truncateLegend\":true,\"maxLegendLines\":1,\"labels\":{\"show\":false},\"thresholdLine\":{\"show\":false,\"value\":10,\"width\":1,\"style\":\"full\",\"color\":\"#E7664C\"},\"row\":false}}"},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T08:22:56.467Z","id":"ccd99080-c34a-11ed-85ef-bb8e0aa6c335","migrationVersion":{"visualization":"8.5.0"},"references":[{"id":"26c84e53-5e3d-4f41-aace-4e4edbfcbcce","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1679818976467,80],"type":"visualization","updated_at":"2023-03-26T08:22:56.467Z","version":"Wzg4LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"docker.info.containers.total : * \",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"title":"Number of Docker containers","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Number of Docker containers\",\"type\":\"gauge\",\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"params\":{\"emptyAsNull\":false},\"schema\":\"metric\"}],\"params\":{\"type\":\"gauge\",\"addTooltip\":true,\"addLegend\":true,\"isDisplayWarning\":false,\"gauge\":{\"alignment\":\"automatic\",\"extendRange\":true,\"percentageMode\":false,\"gaugeType\":\"Arc\",\"gaugeStyle\":\"Full\",\"backStyle\":\"Full\",\"orientation\":\"vertical\",\"colorSchema\":\"Green to Red\",\"gaugeColorMode\":\"Labels\",\"colorsRange\":[{\"from\":0,\"to\":50},{\"from\":50,\"to\":75},{\"from\":75,\"to\":100}],\"invertColors\":false,\"labels\":{\"show\":true,\"color\":\"black\"},\"scale\":{\"show\":true,\"labels\":false,\"color\":\"rgba(105,112,125,0.2)\"},\"type\":\"meter\",\"style\":{\"bgWidth\":0.9,\"width\":0.9,\"mask\":false,\"bgMask\":false,\"maskBars\":50,\"bgFill\":\"rgba(105,112,125,0.2)\",\"bgColor\":true,\"subText\":\"\",\"fontSize\":60}}}}"},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T09:38:04.896Z","id":"e0a6ced0-cbb9-11ed-92ee-29da26875cfd","migrationVersion":{"visualization":"8.5.0"},"references":[{"id":"26c84e53-5e3d-4f41-aace-4e4edbfcbcce","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1679823484896,964],"type":"visualization","updated_at":"2023-03-26T09:38:04.896Z","version":"Wzk1NiwxXQ=="}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"optionsJSON":"{\"useMargins\":true,\"syncColors\":false,\"syncCursor\":true,\"syncTooltips\":false,\"hidePanelTitles\":false}","panelsJSON":"[{\"version\":\"8.6.2\",\"type\":\"visualization\",\"gridData\":{\"x\":0,\"y\":0,\"w\":48,\"h\":14,\"i\":\"8fbc4060-5938-4ab1-9f78-9ca87b3a75cc\"},\"panelIndex\":\"8fbc4060-5938-4ab1-9f78-9ca87b3a75cc\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_8fbc4060-5938-4ab1-9f78-9ca87b3a75cc\"},{\"version\":\"8.6.2\",\"type\":\"visualization\",\"gridData\":{\"x\":0,\"y\":14,\"w\":24,\"h\":15,\"i\":\"8afb7857-6534-413f-830a-a66235193f1f\"},\"panelIndex\":\"8afb7857-6534-413f-830a-a66235193f1f\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_8afb7857-6534-413f-830a-a66235193f1f\"},{\"version\":\"8.6.2\",\"type\":\"visualization\",\"gridData\":{\"x\":10,\"y\":29,\"w\":24,\"h\":15,\"i\":\"c8002288-e907-4fc2-89cb-68d7e0780195\"},\"panelIndex\":\"c8002288-e907-4fc2-89cb-68d7e0780195\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_c8002288-e907-4fc2-89cb-68d7e0780195\"},{\"version\":\"8.6.2\",\"type\":\"visualization\",\"gridData\":{\"x\":24,\"y\":14,\"w\":24,\"h\":15,\"i\":\"cf698c1c-2466-4242-b5c5-4998ba11e288\"},\"panelIndex\":\"cf698c1c-2466-4242-b5c5-4998ba11e288\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_cf698c1c-2466-4242-b5c5-4998ba11e288\"}]","timeRestore":false,"title":"Resources","version":1},"coreMigrationVersion":"8.6.2","created_at":"2023-03-26T09:38:25.293Z","id":"f3fec630-c34a-11ed-85ef-bb8e0aa6c335","migrationVersion":{"dashboard":"8.6.0"},"references":[{"id":"9182d460-c34a-11ed-85ef-bb8e0aa6c335","name":"8fbc4060-5938-4ab1-9f78-9ca87b3a75cc:panel_8fbc4060-5938-4ab1-9f78-9ca87b3a75cc","type":"visualization"},{"id":"22fc9c10-c34a-11ed-85ef-bb8e0aa6c335","name":"8afb7857-6534-413f-830a-a66235193f1f:panel_8afb7857-6534-413f-830a-a66235193f1f","type":"visualization"},{"id":"ccd99080-c34a-11ed-85ef-bb8e0aa6c335","name":"c8002288-e907-4fc2-89cb-68d7e0780195:panel_c8002288-e907-4fc2-89cb-68d7e0780195","type":"visualization"},{"id":"e0a6ced0-cbb9-11ed-92ee-29da26875cfd","name":"cf698c1c-2466-4242-b5c5-4998ba11e288:panel_cf698c1c-2466-4242-b5c5-4998ba11e288","type":"visualization"}],"sort":[1679823505293,991],"type":"dashboard","updated_at":"2023-03-26T09:38:25.293Z","version":"Wzk3NCwxXQ=="}
{"excludedObjects":[],"excludedObjectsCount":0,"exportedCount":7,"missingRefCount":0,"missingReferences":[]}"